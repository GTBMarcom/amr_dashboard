<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AGV ROI 결과</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .product-card img {
      aspect-ratio: 3 / 1;
      object-fit: contain;
      background-color: white;
    }
  </style>
</head>
<body class="dark:bg-[#080b12] dark:text-white bg-white text-black">
  <div class="p-4 flex justify-between items-center">
    <button onclick="toggleDarkMode()" class="bg-gray-200 dark:bg-gray-700 text-black dark:text-white px-3 py-1 rounded">☀️ / 🌙</button>
    <button onclick="downloadPDF()" class="bg-[#79c9c7] text-[#080b12] px-4 py-2 rounded font-semibold">PDF 저장</button>
  </div>

  <div class="grid md:grid-cols-4 gap-4 max-w-7xl mx-auto">
    <div class="md:col-span-1 space-y-2 overflow-y-auto max-h-[90vh]">
      <div class="bg-white dark:bg-gray-800 p-2 rounded shadow">
        <h3 class="font-bold text-lg mb-2">제품 목록</h3>
        <div class="space-y-2">
          <div class="product-card flex gap-2 items-center p-2 border rounded">
            <img src="http://gtbkorea.com/board/download/424b70200f0fdedb814795970d94d737" alt="M6-300N" class="w-24 h-20">
            <div>
              <div class="font-semibold">M6-300N</div>
              <div class="text-sm">하중: 300kg<br>속도: 1.0m/s<br>시간: 8h</div>
            </div>
          </div>
          <div class="product-card flex gap-2 items-center p-2 border rounded">
            <img src="http://gtbkorea.com/board/download/f707273357c45ecf554f773fcc29b27d" alt="M6-600" class="w-24 h-20">
            <div>
              <div class="font-semibold">M6-600</div>
              <div class="text-sm">하중: 600kg<br>속도: 1.2m/s<br>시간: 10h</div>
            </div>
          </div>
          <!-- 다른 모델들도 동일한 형태로 나열 가능 -->
        </div>
      </div>
    </div>

    <div class="md:col-span-3 px-4">
      <h2 class="text-2xl font-bold mb-4 text-center">AGV/AMR 투자 ROI 결과</h2>
      <canvas id="roiChart" class="bg-white dark:bg-gray-800 rounded shadow mb-8"></canvas>
      <canvas id="monthlyChart" class="bg-white dark:bg-gray-800 rounded shadow"></canvas>
    </div>
  </div>

  <script>
    function toggleDarkMode() {
      document.documentElement.classList.toggle('dark');
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.html(document.body, {
        callback: function (pdf) {
          pdf.save('ROI-Result.pdf');
        },
        x: 10,
        y: 10,
        html2canvas: { scale: 0.6 }
      });
    }

    const params = new URLSearchParams(window.location.search);
    const employees = Number(params.get('employees') || 3);
    const hourlyCost = Number(params.get('hourlyCost') || 15000);
    const shiftHours = Number(params.get('shiftHours') || 8);
    const shiftsPerDay = Number(params.get('shiftsPerDay') || 2);
    const daysPerWeek = Number(params.get('daysPerWeek') || 5);
    const weeksPerYear = Number(params.get('weeksPerYear') || 50);

    const annualLaborCost = employees * hourlyCost * shiftHours * shiftsPerDay * daysPerWeek * weeksPerYear;
    const agvInitialCost = 50000000;
    const agvMonthlyCost = 1100000;
    const months = 24;

    const baseline = [];
    const agvLine = [];
    for (let i = 0; i < months; i++) {
      baseline.push(Math.round((annualLaborCost / 12) * (i + 1)));
      agvLine.push(Math.round(agvInitialCost + agvMonthlyCost * i));
    }

    const crossingIndex = agvLine.findIndex((v, i) => v < baseline[i]);
    const labels = Array.from({ length: months }, (_, i) => `${i + 1}개월`);

    const ctx = document.getElementById('roiChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: '기존 인건비', data: baseline, borderColor: '#79c9c7', borderWidth: 2, fill: false },
          { label: 'AGV 누적비용', data: agvLine, borderColor: '#f87171', borderWidth: 2, fill: false },
          crossingIndex >= 0 ? {
            label: '손익분기점',
            data: Array.from({ length: months }, (_, i) => i === crossingIndex ? agvLine[i] : null),
            pointBackgroundColor: 'yellow',
            pointRadius: 6,
            type: 'line',
            borderWidth: 0,
            pointStyle: 'rectRot'
          } : {}
        ]
      },
      options: {
        responsive: true,
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.formattedValue}원`
            }
          }
        }
      }
    });

    const ctx2 = document.getElementById('monthlyChart').getContext('2d');
    const savingRates = Array.from({ length: months }, (_, i) => {
      const base = baseline[i];
      const agv = agvLine[i];
      return base > agv ? ((base - agv) / base) : 0;
    });

    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: '절감률', data: savingRates, backgroundColor: '#79c9c7' }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 1 }
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: ctx => `절감률: ${(ctx.raw * 100).toFixed(1)}%`
            }
          }
        }
      }
    });
  </script>
</body>
</html>
